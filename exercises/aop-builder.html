<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build the AOP - Interactive Exercise</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .instructions {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .game-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
            }
        }

        .card-pool {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-pool h2 {
            margin-top: 0;
            color: #34495e;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 200px;
        }

        .card {
            padding: 15px;
            border-radius: 8px;
            cursor: grab;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .card.mie {
            background: #3498db;
            color: white;
            border: 2px solid #2980b9;
        }

        .card.ke {
            background: #f1c40f;
            color: #333;
            border: 2px solid #d4ac0d;
        }

        .card.ao {
            background: #e74c3c;
            color: white;
            border: 2px solid #c0392b;
        }

        .card-type {
            font-size: 0.75em;
            opacity: 0.8;
            display: block;
            margin-bottom: 5px;
        }

        .drop-zones {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .drop-zones h2 {
            margin-top: 0;
            color: #34495e;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .pathway {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drop-zone {
            min-height: 70px;
            border: 3px dashed #bdc3c7;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            transition: background 0.2s, border-color 0.2s;
            position: relative;
        }

        .drop-zone.mie-zone {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .drop-zone.ke-zone {
            border-color: #f1c40f;
            background: rgba(241, 196, 15, 0.1);
        }

        .drop-zone.ao-zone {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .drop-zone.drag-over {
            background: rgba(46, 204, 113, 0.2);
            border-color: #27ae60;
        }

        .drop-zone .label {
            color: #95a5a6;
            font-style: italic;
        }

        .drop-zone .card {
            margin: 0;
            width: 100%;
        }

        .arrow {
            text-align: center;
            font-size: 24px;
            color: #95a5a6;
        }

        .controls {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        button:hover {
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .check-btn {
            background: #27ae60;
            color: white;
        }

        .check-btn:hover {
            background: #219a52;
        }

        .reset-btn {
            background: #95a5a6;
            color: white;
        }

        .reset-btn:hover {
            background: #7f8c8d;
        }

        .next-btn {
            background: #3498db;
            color: white;
        }

        .next-btn:hover {
            background: #2980b9;
        }

        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }

        .feedback.correct {
            background: #d5f5e3;
            border: 2px solid #27ae60;
            color: #1e8449;
            display: block;
        }

        .feedback.incorrect {
            background: #fadbd8;
            border: 2px solid #e74c3c;
            color: #943126;
            display: block;
        }

        .aop-selector {
            text-align: center;
            margin-bottom: 30px;
        }

        .aop-selector select {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 6px;
            border: 2px solid #3498db;
            background: white;
            cursor: pointer;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-color.mie { background: #3498db; }
        .legend-color.ke { background: #f1c40f; }
        .legend-color.ao { background: #e74c3c; }

        .progress {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }

        .links {
            margin-top: 40px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            text-align: center;
        }

        .links a {
            color: #3498db;
            text-decoration: none;
        }

        .links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>Build the AOP</h1>
    <p class="subtitle">Interactive Adverse Outcome Pathway Exercise</p>

    <div class="instructions">
        <strong>Instructions:</strong> Drag the cards from the left panel and drop them in the correct order on the right.
        Build the pathway from the Molecular Initiating Event (MIE) through Key Events (KE) to the Adverse Outcome (AO).
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color mie"></div>
            <span>MIE (Molecular Initiating Event)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color ke"></div>
            <span>KE (Key Event)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color ao"></div>
            <span>AO (Adverse Outcome)</span>
        </div>
    </div>

    <div class="aop-selector">
        <label for="aop-select"><strong>Select AOP:</strong></label>
        <select id="aop-select">
            <option value="0">1. Lead Neurotoxicity</option>
            <option value="1">2. Estrogen Receptor → Reproductive Effects</option>
            <option value="2">3. Liver Enzyme Inhibition → Hepatotoxicity</option>
        </select>
    </div>

    <div class="progress" id="progress">AOP 1 of 3</div>

    <div class="game-container">
        <div class="card-pool">
            <h2>Available Cards</h2>
            <div class="cards" id="card-pool">
                <!-- Cards will be populated by JavaScript -->
            </div>
        </div>

        <div class="drop-zones">
            <h2>Build the Pathway</h2>
            <div class="pathway" id="pathway">
                <!-- Drop zones will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="check-btn" onclick="checkAnswer()">Check Answer</button>
        <button class="reset-btn" onclick="resetGame()">Reset</button>
        <button class="next-btn" onclick="nextAOP()">Next AOP →</button>
    </div>

    <div class="feedback" id="feedback"></div>

    <div class="links">
        <h3>Learn More</h3>
        <p>
            <a href="https://aopwiki.org/" target="_blank">AOP-Wiki</a> |
            <a href="https://www.vhp4safety.nl/" target="_blank">VHP4Safety</a> |
            <a href="https://www.wikipathways.org/" target="_blank">WikiPathways</a>
        </p>
    </div>

    <script>
        // AOP Data - 3 example AOPs
        const aopData = [
            {
                name: "Lead Neurotoxicity",
                aopWikiId: "13",
                cards: [
                    { id: "mie1", type: "mie", text: "Lead binds to NMDA receptors" },
                    { id: "ke1", type: "ke", text: "Decreased calcium influx" },
                    { id: "ke2", type: "ke", text: "Impaired synaptic plasticity" },
                    { id: "ke3", type: "ke", text: "Decreased neuronal network function" },
                    { id: "ao1", type: "ao", text: "Learning and memory impairment" }
                ],
                correctOrder: ["mie1", "ke1", "ke2", "ke3", "ao1"],
                explanation: "Lead (Pb) binds to NMDA receptors, blocking normal calcium signaling. This impairs synaptic plasticity (the ability of synapses to strengthen or weaken), disrupting neuronal network function and ultimately causing learning and memory deficits."
            },
            {
                name: "Estrogen Receptor → Reproductive Effects",
                aopWikiId: "30",
                cards: [
                    { id: "mie2", type: "mie", text: "Chemical binds to estrogen receptor" },
                    { id: "ke4", type: "ke", text: "Altered gene expression" },
                    { id: "ke5", type: "ke", text: "Disrupted hormone synthesis" },
                    { id: "ke6", type: "ke", text: "Altered reproductive organ development" },
                    { id: "ao2", type: "ao", text: "Decreased fertility" }
                ],
                correctOrder: ["mie2", "ke4", "ke5", "ke6", "ao2"],
                explanation: "Endocrine disrupting chemicals can bind to estrogen receptors, mimicking or blocking natural estrogen. This alters gene expression controlling hormone synthesis, disrupts reproductive organ development, and ultimately decreases fertility."
            },
            {
                name: "Liver Enzyme Inhibition → Hepatotoxicity",
                aopWikiId: "220",
                cards: [
                    { id: "mie3", type: "mie", text: "Chemical inhibits CYP450 enzymes" },
                    { id: "ke7", type: "ke", text: "Accumulation of toxic metabolites" },
                    { id: "ke8", type: "ke", text: "Mitochondrial dysfunction" },
                    { id: "ke9", type: "ke", text: "Hepatocyte cell death" },
                    { id: "ao3", type: "ao", text: "Liver failure" }
                ],
                correctOrder: ["mie3", "ke7", "ke8", "ke9", "ao3"],
                explanation: "Certain chemicals can inhibit liver CYP450 enzymes responsible for detoxification. This causes toxic metabolites to accumulate, damaging mitochondria (the cell's energy source). Without functional mitochondria, liver cells die, potentially leading to liver failure."
            }
        ];

        let currentAOP = 0;
        let draggedCard = null;

        function initGame() {
            const aop = aopData[currentAOP];
            const cardPool = document.getElementById('card-pool');
            const pathway = document.getElementById('pathway');
            const progress = document.getElementById('progress');

            // Clear existing content
            cardPool.innerHTML = '';
            pathway.innerHTML = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('feedback').innerHTML = '';

            // Update progress
            progress.textContent = `AOP ${currentAOP + 1} of ${aopData.length}: ${aop.name}`;

            // Shuffle cards
            const shuffledCards = [...aop.cards].sort(() => Math.random() - 0.5);

            // Create cards
            shuffledCards.forEach(card => {
                const cardEl = createCard(card);
                cardPool.appendChild(cardEl);
            });

            // Create drop zones
            const zoneTypes = [
                { type: 'mie', label: 'MIE - Molecular Initiating Event' },
                { type: 'ke', label: 'KE1 - Key Event 1' },
                { type: 'ke', label: 'KE2 - Key Event 2' },
                { type: 'ke', label: 'KE3 - Key Event 3' },
                { type: 'ao', label: 'AO - Adverse Outcome' }
            ];

            zoneTypes.forEach((zone, index) => {
                if (index > 0) {
                    const arrow = document.createElement('div');
                    arrow.className = 'arrow';
                    arrow.textContent = '↓';
                    pathway.appendChild(arrow);
                }

                const dropZone = document.createElement('div');
                dropZone.className = `drop-zone ${zone.type}-zone`;
                dropZone.dataset.index = index;
                dropZone.innerHTML = `<span class="label">${zone.label}</span>`;

                // Drop zone events
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleDrop);

                pathway.appendChild(dropZone);
            });

            // Update selector
            document.getElementById('aop-select').value = currentAOP;
        }

        function createCard(cardData) {
            const card = document.createElement('div');
            card.className = `card ${cardData.type}`;
            card.draggable = true;
            card.dataset.id = cardData.id;
            card.dataset.type = cardData.type;

            const typeLabel = cardData.type === 'mie' ? 'MIE' :
                             cardData.type === 'ke' ? 'KE' : 'AO';

            card.innerHTML = `<span class="card-type">${typeLabel}</span>${cardData.text}`;

            // Drag events
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            // Touch events for mobile
            card.addEventListener('touchstart', handleTouchStart, { passive: false });
            card.addEventListener('touchmove', handleTouchMove, { passive: false });
            card.addEventListener('touchend', handleTouchEnd);

            return card;
        }

        function handleDragStart(e) {
            draggedCard = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedCard = null;
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropZone = e.currentTarget;
            dropZone.classList.remove('drag-over');

            if (draggedCard) {
                // If zone already has a card, move it back to pool
                const existingCard = dropZone.querySelector('.card');
                if (existingCard) {
                    document.getElementById('card-pool').appendChild(existingCard);
                }

                // Remove placeholder label
                const label = dropZone.querySelector('.label');
                if (label) label.style.display = 'none';

                // Add card to drop zone
                dropZone.appendChild(draggedCard);
            }
        }

        // Touch handling for mobile
        let touchStartY = 0;
        let touchCard = null;

        function handleTouchStart(e) {
            touchCard = e.target.closest('.card');
            if (touchCard) {
                touchStartY = e.touches[0].clientY;
                touchCard.classList.add('dragging');
            }
        }

        function handleTouchMove(e) {
            if (!touchCard) return;
            e.preventDefault();

            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);

            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });

            if (element && element.closest('.drop-zone')) {
                element.closest('.drop-zone').classList.add('drag-over');
            }
        }

        function handleTouchEnd(e) {
            if (!touchCard) return;

            const touch = e.changedTouches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            const dropZone = element ? element.closest('.drop-zone') : null;

            if (dropZone) {
                const existingCard = dropZone.querySelector('.card');
                if (existingCard && existingCard !== touchCard) {
                    document.getElementById('card-pool').appendChild(existingCard);
                }

                const label = dropZone.querySelector('.label');
                if (label) label.style.display = 'none';

                dropZone.appendChild(touchCard);
            }

            touchCard.classList.remove('dragging');
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
            touchCard = null;
        }

        function checkAnswer() {
            const aop = aopData[currentAOP];
            const dropZones = document.querySelectorAll('.drop-zone');
            const feedback = document.getElementById('feedback');

            let userOrder = [];
            let allFilled = true;

            dropZones.forEach((zone, index) => {
                const card = zone.querySelector('.card');
                if (card) {
                    userOrder.push(card.dataset.id);
                } else {
                    allFilled = false;
                }
            });

            if (!allFilled) {
                feedback.className = 'feedback incorrect';
                feedback.innerHTML = '<strong>Incomplete!</strong> Please place all cards in the pathway before checking.';
                return;
            }

            const isCorrect = userOrder.every((id, index) => id === aop.correctOrder[index]);

            if (isCorrect) {
                feedback.className = 'feedback correct';
                feedback.innerHTML = `
                    <strong>Correct!</strong>
                    <p>${aop.explanation}</p>
                    <p><a href="https://aopwiki.org/aops/${aop.aopWikiId}" target="_blank">View this AOP on AOP-Wiki →</a></p>
                `;
            } else {
                feedback.className = 'feedback incorrect';
                feedback.innerHTML = `
                    <strong>Not quite right.</strong>
                    <p>Think about the biological sequence: What happens first at the molecular level? What cascading effects follow? What is the final adverse outcome?</p>
                    <p>Hint: Follow the cause-and-effect relationships.</p>
                `;
            }
        }

        function resetGame() {
            initGame();
        }

        function nextAOP() {
            currentAOP = (currentAOP + 1) % aopData.length;
            document.getElementById('aop-select').value = currentAOP;
            initGame();
        }

        // AOP selector change
        document.getElementById('aop-select').addEventListener('change', function(e) {
            currentAOP = parseInt(e.target.value);
            initGame();
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
